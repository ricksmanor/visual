<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>VBA HTML Cleaner</title>
<style>
body { font-family: Arial, sans-serif; padding: 18px; max-width:900px; }
#editor { border:1px solid #ccc; padding:10px; min-height:160px; margin-bottom:10px; }
input[type="text"]{ width:100%; padding:8px; margin-bottom:10px; }
button{ padding:8px 12px; margin-right:8px; margin-bottom:6px; }
pre{ background:#f7f7f7; padding:10px; white-space:pre-wrap; word-break:break-word; }
.toolbar { margin-bottom:10px; }
</style>
</head>
<body>

<h2>VBA HTML Cleaner</h2>
<p>Paste formatted content. Bold, colour and small text will be preserved.</p>

<div class="toolbar">
<button onclick="formatBold()">Bold</button>
<input type="color" id="colorPicker">
<button onclick="applyColor()">Apply Colour</button>
<button onclick="applySmall()">Small Text</button>
<button onclick="removeFormat()">Clear Formatting</button>
</div>

<div id="editor" contenteditable="true">
<p>Save <strong>an extra 10% on Milton Keynes storage plus a FREE lock (£15.99)</strong>!</p>
<p>Not online. Limited units – book your space today.</p>
<p>[Reserve Your Unit Now]</p>
</div>

<label>Link for [Reserve Your Unit Now]:</label>
<input id="link" placeholder="https://example.com">

<div style="margin-bottom:10px;">
<button onclick="generateVBA()">Generate VBA</button>
<button onclick="copyOutput()">Copy Output</button>
<button onclick="clearEditor()">Clear Editor</button>
</div>

<h3>VBA Output</h3>
<pre id="output"></pre>

<script>

// ===== Formatting Functions =====

function formatBold() {
    document.execCommand("bold");
}

function applyColor() {
    const color = document.getElementById("colorPicker").value;
    document.execCommand("foreColor", false, color);
}

function applySmall() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;

    const range = selection.getRangeAt(0);
    const span = document.createElement("span");
    span.style.fontSize = "12px";
    range.surroundContents(span);
}

function removeFormat() {
    document.execCommand("removeFormat");
}


// ===== Cleaner =====

function cleanWordHtml(html) {

    html = html.replace(/<o:p>.*?<\/o:p>/gi, '');
    html = html.replace(/<o:p\s*\/>/gi, '');
    html = html.replace(/\sclass="[^"]*"/gi, '');
    html = html.replace(/\sstyle="(?![^"]*color)(?![^"]*font-size)[^"]*"/gi, '');

    html = html.replace(/<\s*b\s*>/gi, '<strong>');
    html = html.replace(/<\s*\/\s*b\s*>/gi, '</strong>');

    html = html.replace(/<p>\s*(?:&nbsp;|\s)*<\/p>/gi, '');

    return html.trim();
}


// ===== Generate VBA =====

function generateVBA() {

    const editor = document.getElementById('editor');
    const link = document.getElementById('link').value.trim();

    let html = editor.innerHTML || '';
    html = cleanWordHtml(html);

    html = html.replace(/[–—]/g, "-");

    // Auto phone detection
    html = html.replace(/(\b0\d{2,4}[\s-]?\d{3,4}[\s-]?\d{3,4}\b)/g, function(match) {
        const digitsOnly = match.replace(/\D/g, '');
        return `<a href="tel:${digitsOnly}">${match}</a>`;
    });

    // Button link
    if (link) {
        html = html.replace(/\[([^\]]+)\]/g,
            `<a href="${link}"><strong>[$1]</strong></a>`
        );
    } else {
        html = html.replace(/\[([^\]]+)\]/g,
            `<strong>[$1]</strong>`
        );
    }

    let parts = html.split(/<\/p>/i)
        .map(s => s.trim())
        .filter(s => s.length > 0);

    const vbaLines = parts.map(part => {

        let seg = part;

        if (!/^<p\b/i.test(seg))
            seg = `<p>${seg}</p>`;
        else
            seg = seg + '</p>';

        seg = seg.replace(/^<p\b[^>]*>/i, '<p>');

        seg = seg.replace(/"/g, '""');
        seg = seg.replace(/\r?\n|\r/g, ' ');

        return `.HTMLBody = .HTMLBody & "${seg}"`;
    });

    document.getElementById('output').textContent = vbaLines.join("\n");
}


// ===== Utilities =====

function copyOutput(){
    const out = document.getElementById('output').textContent;
    if(!out) return alert('No output to copy — generate first.');
    navigator.clipboard.writeText(out).then(()=> {
        alert('Copied to clipboard');
    });
}

function clearEditor(){
    document.getElementById('editor').innerHTML = '<p></p>';
    document.getElementById('output').textContent = '';
}

</script>
</body>
</html>
